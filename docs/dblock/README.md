# π§µ λ™μ‹μ„± μ μ–΄ μ „λµ λ³΄κ³ μ„

## β… λ°°κ²½ λ° κ°μ”

λ³Έ λ³΄κ³ μ„λ” **ν¬μΈνΈ μ¶©μ „/μ°¨κ°**, **μƒν’ μ¬κ³  μ°¨κ° λ° λ³µμ›**, **μ„ μ°©μ μΏ ν° λ°κΈ‰** κΈ°λ¥μ—μ„ λ°μƒν•  μ μλ” **λ™μ‹μ„± λ¬Έμ **λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄ μ μ©ν• **λ½ μ „λµ**κ³Ό ν…μ¤νΈ κ²°κ³Όλ¥Ό μ •λ¦¬ν• λ¬Έμ„μ…λ‹λ‹¤.

κ° λ„λ©”μΈλ³„ λ‹¤μ μƒν™©μ„ κ³ λ ¤ν•μ€μµλ‹λ‹¤: 

- **ν¬μΈνΈ**: κΈμ•΅μ μ²λ¦¬λ” μ‚¬μ©μμ μ†μ‹¤κ³Ό μ§κ²°λλ©°, μ—¬λ¬ μ”μ²­μ΄ λ“¤μ–΄μ¤λ” λ™μ‹μ„± μƒν™© λ°μƒ μ‹ μ •ν•©μ„±μ„ κ³ λ ¤ν•΄μ•Ό ν•¨.
- **μΏ ν° λ°κΈ‰**: ν•μ •λ μλ‰μ μΏ ν°μ— λ€ν•΄ λ‹¤μμ μ‚¬μ©μκ°€ λ™μ‹μ— λ°κΈ‰ μ”μ²­ μ‹, μ„ μ°©μ μ΅°κ±΄μ„ μ¶©μ΅±ν•λ©° μ¤‘λ³µ λ°κΈ‰μ„ λ°©μ§€ν•΄μ•Ό ν•¨
- **μ¬κ³  κ΄€λ¦¬**: λ‹¤μ μ£Όλ¬Έ μ”μ²­μ΄ λ™μ‹μ— λ°μƒν•λ” μƒν™©μ—μ„ μ‹¤μ  μ¬κ³  μλ‰κ³Ό DB λ°μ΄ν„° κ°„ λ¶μΌμΉλ¥Ό λ°©μ§€ν•κ³ , μ΄κ³Ό νλ§¤λ¥Ό μ°¨λ‹¨ν•΄μ•Ό ν•¨
---

## β οΈ λ¬Έμ  λ¶„μ„ (λ½ λ―Έμ μ© μ‹)

### 1. **ν¬μΈνΈ λ„λ©”μΈ - Race Condition λ°μƒ**

**μ¶©μ „ ν…μ¤νΈ κ²°κ³Ό**
```
μ΄κΈ° μ”μ•΅: 1000
μµμΆ… μ”μ•΅: 1300
μμƒ μ”μ•΅: 1500  β (200P λ„λ½)
```

**μ°¨κ° ν…μ¤νΈ κ²°κ³Ό**
```
μ΄κΈ° μ”μ•΅: 1000
μµμΆ… μ”μ•΅: 700
μμƒ μ”μ•΅: 500  β (200P κ³Όλ‹¤ μ”μ΅΄)
```

**μ›μΈ**: λ³‘λ ¬ μ”μ²­μ΄ λ™μΌν• μ”μ•΅ μƒνƒλ¥Ό κΈ°μ¤€μΌλ΅ μ—°μ‚° β†’ μΌλ¶€ νΈλμ­μ… κ²°κ³Όκ°€ λ®μ–΄μ”μ›μ§

### 2. **μΏ ν° λ„λ©”μΈ - Race Condition λ°μƒ λ° μ΄κ³Ό λ°κΈ‰ λ¬Έμ **

```
μ΄ μ”μ²­ μ: 5
λ°κΈ‰ κ°€λ¥ μλ‰: 1
μ„±κ³µ: 3κ±΄
μ‹¤ν¨: 2κ±΄
μ‹¤μ  λ°κΈ‰: 3κ±΄  β (2κ±΄ μ΄κ³Ό λ°κΈ‰)
```

**μ›μΈ**: λ°κΈ‰ κ°€λ¥ μλ‰μ„ μ΅°ν ν›„ λ°κΈ‰ν•λ” μ‚¬μ΄μ— λ‹¤λ¥Έ νΈλμ­μ…μ΄ λ°κΈ‰ μ™„λ£

### 3. **μ¬κ³  λ„λ©”μΈ - Race Condition λ°μƒ μ‹ μ°¨κ°/λ³µμ› λ„λ½**

**μ°¨κ° μ‹ λ¬Έμ **
```
μ΄κΈ° μ¬κ³ : 100
μμƒ μ¬κ³ : 75
μ‹¤μ  μ¬κ³ : 90  β (5κ° λ μ°¨κ°λ¨)
```

**λ³µμ› μ‹ λ¬Έμ **
```
κ°μ† ν›„ μ¬κ³ : 75
μμƒ λ³µμ› ν›„: 100
μ‹¤μ  λ³µμ› ν›„: 85  β (15κ° λ¶€μ΅±)
```

**μ›μΈ**: μ¬κ³  κ°μ†/λ³µμ› μ—°μ‚° μ¤‘ λ‹¤λ¥Έ μ¤λ λ“κ°€ λ™μΌ μ¬κ³  μλ‰μ„ μ½μ–΄ μ²λ¦¬ β†’ μ¤‘κ°„ κ°’ λ®μ–΄μ“°κΈ° λ°μƒ

---

## β™οΈ λ‹¨κ³„λ³„ ν•΄κ²° λ°©λ²• λ„μ¶ λ° μ μ©

### β… 1λ‹¨κ³„: ν¬μΈνΈ λ„λ©”μΈ - λ‚™κ΄€μ  λ½ μ μ©

```sql
-- Entity ν΄λμ¤μ— @Version μ–΄λ…Έν…μ΄μ… μ¶”κ°€
@Version
private Long version;

-- μ¬μ‹λ„ λ΅μ§ κµ¬ν„ (μµλ€ 5ν)
@Retryable(value = {OptimisticLockingFailureException.class}, 
           maxAttempts = 5)
```

**ν…μ¤νΈ κ²°κ³Ό (10κ±΄ λ™μ‹ μ”μ²­)**
```
μ„±κ³µ: 4κ±΄
μ‹¤ν¨: 6κ±΄
μμ™Έ: Row was updated or deleted by another transaction...
μ΄κΈ° μ”μ•΅: 1000
μµμΆ… μ”μ•΅: 600 (μ •ν•©μ„±μ€ μ μ§€λλ‚ μ‹¤ν¨ μ”μ²­ λ‹¤μ)
```
> ### β οΈ λ¬Έμ  μƒν™© λ°μƒ:
>- ν• λ…μ μ μ €κ°€ λ™μ‹μ— μ—¬λ¬λ² ν¬μΈνΈ μ¶©μ „μ„ μ”μ²­ν•λ” μ¶©λ μƒν™©μ΄ λ§μ΄ λ°μƒν•μ§€ μ•μ„ κ²ƒμ΄λΌ μƒκ°, μ„±λ¥μ„ κ³ λ ¤ν•μ—¬ λ‚™κ΄€μ  λ½μ„ μ μ©
>- κ·Έλ¬λ‚, ν…μ¤νΈ κ²°κ³Ό μ„±κ³µλ¥  40%λ΅ μƒκ° λ³΄λ‹¤ λ†’μ€ ν™•λ¥ λ΅ ν¬μΈνΈ μ¶©μ „μ΄ λμ§€ μ•μ•κ³ , μ •ν•©μ„±μ΄ λ³΄μ¥λμ§€ μ•λ”λ‹¤λ” κ²ƒμ„ λ°κ²¬ 
>> β†’ ν¬μΈνΈ μ¶©μ „μ΄ μ„±κ³µν•  λ•κΉμ§€ μ¬μ‹λ„ μ‹ DBμ— λ€ν• λ¶€ν•μ™€, ν¬μΈνΈ λ„λ©”μΈ νΉμ„± μƒ κΈμµ κ°€μΉκ°€ μμΌλ―€λ΅ μΌλ¶€ μ”μ²­ μ‹¤ν¨λ„ UXμ— μ•…μν–¥μ„ μ¤„ κ²ƒμ„ κ³ λ ¤ν•μ—¬ λΉ„κ΄€μ  λ½μΌλ΅ λ³€κ²½

---

### β… 2λ‹¨κ³„: ν¬μΈνΈ λ„λ©”μΈ - λΉ„κ΄€μ  λ½μΌλ΅ μ „ν™

```sql
-- PESSIMISTIC_WRITE λ½ μ μ©
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Point p WHERE p.userId = :userId")
Optional<Point> findByUserIdWithLock(@Param("userId") Long userId);
```

- λ‚™κ΄€μ  λ½ λ€λΉ„ **ν•­μƒ μ„±κ³µμ„ λ³΄μ¥**ν•λ” μ•μ •μ μΈ μ²λ¦¬
- μ¬μ‹λ„ λΉ„μ©κ³Ό μ‚¬μ©μ κ²½ν—μ„ κ³ λ ¤ν•΄ **λΉ„κ΄€μ  λ½**μ„ μ μ©

---

### β… 3λ‹¨κ³„: μΏ ν°/μ¬κ³  λ„λ©”μΈ - λΉ„κ΄€μ  λ½ μ μ©

```sql
-- μΏ ν° λ°κΈ‰ μ‹ λΉ„κ΄€μ  λ½
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT c FROM Coupon c WHERE c.couponId = :couponId")
Optional<Coupon> findByCouponIdWithLock(@Param("couponId") Long couponId);

-- μ¬κ³  μ°¨κ°/λ³µμ› μ‹ λΉ„κ΄€μ  λ½
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT p FROM Product p WHERE p.productId = :productId")
Optional<Product> findByProductIdWithLock(@Param("productId") Long productId);
```
- μ„ μ°©μ μΏ ν°: κ²½μμ΄ μ‹¬ν•κ³  μ΄κ³Ό λ°κΈ‰μ„ μ°¨λ‹¨ν•  ν•„μ” β†’ **λΉ„κ΄€μ  λ½** μ μ© 
- μ¬κ³  μ°¨κ°/λ³µμ›: λ™μ‹μ— μ”μ²­μ΄ λ°μƒν•  κ°€λ¥μ„±μ΄ λ†’μΌλ©°, μ¬κ³  νΉμ„±μƒ λ°μ΄ν„° μ •ν•©μ„±μ„ μµμ°μ„ μΌλ΅ λ³΄μ¥ν•΄μ•Ό ν•¨. β†’ **λΉ„κ΄€μ  λ½** μ μ©
---

## π“ μ‹¤ν— κ²°κ³Ό

### π’΅ ν¬μΈνΈ μ”μ•΅ λ™μ‹μ„± ν…μ¤νΈ κ²°κ³Ό

| μ‹λ‚λ¦¬μ¤ | ν…μ¤νΈ λ‚΄μ©         | μ΄κΈ° μ”μ•΅ | μ”μ²­ μ | μ„±κ³µ μ | μ‹¤ν¨ μ | μµμΆ… μ”μ•΅ | μμƒ μ”μ•΅ | κ²°κ³Ό               |
|----------|----------------|-----------|---------|---------|----------|-----------|------------|------------------|
| 1 | ν¬μΈνΈ μ¶©μ „ (λ½ λ―Έμ μ©) | 0 | 5 | 3 | 2 | 300 | 500 | β μ‹¤ν¨             |
| 2 | ν¬μΈνΈ μ°¨κ° (λ½ λ―Έμ μ©) | 300 | 5 | 2 | 3 | 100 | -200 | β μ‹¤ν¨             |
| 3 | ν¬μΈνΈ μ¶©μ „ (λ‚™κ΄€μ  λ½) | 100 | 10 | 4 | 6 | 500 | 1100 | β οΈ ν…μ¤νΈλ” μ„±κ³µ, λ©ν‘ μ”μ•΅ μ¶©μ „ μ‹¤ν¨ |
| 4 | ν¬μΈνΈ μ°¨κ° (λ‚™κ΄€μ  λ½) | 1000 | 10 | 4 | 6 | 600 | 600 | β οΈ ν…μ¤νΈλ” μ„±κ³µ, λ©ν‘ μ”μ•΅ μ°¨κ° μ‹¤ν¨ |
| 5 | ν¬μΈνΈ μ¶©μ „ (λΉ„κ΄€μ  λ½) | 600 | 10 | 10 | 0 | 1600 | 1600 | β… μ„±κ³µ             |
| 6 | ν¬μΈνΈ μ°¨κ° (λΉ„κ΄€μ  λ½) | 1000 | 10 | 10 | 0 | 0 | 0 | β… μ„±κ³µ             |

### π’΅ μ„ μ°©μ μΏ ν° λ„λ©”μΈ ν…μ¤νΈ κ²°κ³Ό

| μ‹λ‚λ¦¬μ¤ | μ „λµ | μ”μ²­ μ | μ„±κ³µ μ | μ‹¤ν¨ μ | μ‹¤μ  λ°κΈ‰ μ | κ²°κ³Ό      |
|----------|------|--------|--------|--------|-------------|---------|
| μΏ ν° λ°κΈ‰ (λ½ μ—†μ) | μ—†μ | 5 | 3 | 2 | 3 | β μ΄κ³Ό λ°κΈ‰ |
| μΏ ν° λ°κΈ‰ (λΉ„κ΄€μ  λ½) | λΉ„κ΄€μ  λ½ | 5 | 1 | 4 | 1 | β… μ •μƒ λ°κΈ‰ |

### π’΅ μ¬κ³  λ„λ©”μΈ ν…μ¤νΈ κ²°κ³Ό

| μ‹λ‚λ¦¬μ¤ | μ „λµ | μ”μ²­ μ | μµμΆ… μ¬κ³  | μμƒ μ¬κ³  | κ²°κ³Ό            |
|----------|------|--------|-----------|-----------|---------------|
| μ¬κ³  μ°¨κ° (λ½ μ—†μ) | μ—†μ | 5 | 90 | 75 | β λ©ν‘ μ¬κ³  μ°¨κ° μ‹¤ν¨ |
| μ¬κ³  μ°¨κ° (λΉ„κ΄€μ  λ½) | λΉ„κ΄€μ  λ½ | 5 | 0 | 0 | β… μ°¨κ° μ„±κ³µ       |
| μ¬κ³  λ³µμ› (λ½ μ—†μ) | μ—†μ | 5 | 85 | 100 | β λ©ν‘ μ¬κ³  λ³µμ› μ‹¤ν¨ |
| μ¬κ³  λ³µμ› (λΉ„κ΄€μ  λ½) | λΉ„κ΄€μ  λ½ | 5 | 100 | 100 | β… λ³µμ› μ„±κ³µ       |

---

## π― λΉ„κ΄€μ  λ½ μ„±λ¥ λ¶„μ„

### μ„ μ°©μ μΏ ν° λ°κΈ‰ μ‹ μ„±λ¥ λΉ„κµ (λΉ„κ΄€μ  λ½ vs λ½ μ—†μ)
#### β€» μΏ ν° μ¬κ³ κ°€ μ¶©λ¶„ν• μƒνƒμ—μ„ ν…μ¤νΈλ¥Ό μ§„ν–‰ν•μ€μµλ‹λ‹¤. 

| κµ¬λ¶„ | λ½ μ—†μ | λΉ„κ΄€μ  λ½ | μ„±λ¥ μ²λ¦¬μ‹κ°„       |
| :--- | :--- | :--- |:--------------|
| **μ΄ μ²λ¦¬ μ‹κ°„** | 126 ms | 202 ms | `π”Ί 60.3% μ¦κ°€` |
| **ν‰κ·  μ²λ¦¬ μ‹κ°„** | 101 ms | 143 ms | `π”Ί 41.4% μ¦κ°€` |
| **μµλ€ μ²λ¦¬ μ‹κ°„**| 124 ms | 198 ms | `π”Ί 59.7% μ¦κ°€` |
π“ **λ¶„μ„**
- **μ¥μ **: μΏ ν° μλ‰μ΄ μ •ν™•ν μ μ–΄λμ–΄ μ΄κ³Ό λ°κΈ‰μ΄ λ°μƒν•μ§€ μ•μ
- **λ‹¨μ **: λ½ νλ“ λ€κΈ° μ‹κ°„μ΄ λ°μƒν•΄ **ν‰κ·  μ²λ¦¬ μ‹κ°„μ΄ μ•½ 41% μ¦κ°€**
---

## β… μΆ…ν•© ν‰κ°€ λ° ν–¥ν›„ κ³Όμ 

| ν•­λ© | ν„μ¬ ν•κ³„ | κ°μ„  λ°©μ• |
|------|-----------|-----------|
| μ„±λ¥ μ €ν• | λΉ„κ΄€μ  λ½μΌλ΅ μΈν• ν‰κ·  41% μ²λ¦¬μ‹κ°„ μ¦κ°€ | Redis λ¶„μ‚°λ½, λ©”μ‹μ§€ ν ν™μ© |
| ν™•μ¥μ„± | λ‹¨μΌ DB ν™κ²½μ—μ„λ§ ν…μ¤νΈ | Redisson, λ¶„μ‚°λ½ λ„μ… |
| κ³ κ°€μ©μ„± | λ½ κ²½ν•© μ‹ λ€κΈ°μ‹κ°„ λ°μƒ | λ½ νƒ€μ„μ•„μ›ƒ, λ°±μ¤ν”„ μ „λµ |

> - **μ •ν•©μ„±μ΄ μµμ°μ„ **μΈ λ„λ©”μΈ(ν¬μΈνΈ, μ¬κ³ , μΏ ν°)μ—λ” **λΉ„κ΄€μ  λ½μ΄ κ°€μ¥ μ•μ •μ„±μ„ ν™•λ³΄ν• ν•΄κ²°μ±…**μΌλ΅ λ³΄μ„.
> - **κ³ λ¶€ν• ν™κ²½μ—μ„λ” λΉ„κ΄€μ  λ½ μ μ© μ‹ μ„±λ¥ λ¬Έμ  λ° μ²λ¦¬ μ§€μ—°μ΄ μμƒ λ¨.**
> - ν–¥ν›„ λ€κ·λ¨ νΈλν”½ ν™κ²½μ„ κ³ λ ¤ν•μ—¬ λ¶„μ‚°λ½ λ° νΌν•© μ „λµ κ²€ν†  ν•„μ”
